inheritsFrom: ../../fabalicious/mbb-docker.yaml
tasks:
  mysql:
    - sudo mkdir -p /opt/mysql/data
    - > 
        if ! docker ps | grep -qw mysql; then 
        docker run --name mysql -d 
        -e 'DB_REMOTE_ROOT_NAME=root' 
        -e 'DB_REMOTE_ROOT_PASS=admin'
        -e 'DB_REMOTE_ROOT_HOST=%'
        -v /opt/mysql/data:/var/lib/mysql 
        quay.io/sameersbn/mysql:latest
        ; fi

  restart_mysql:
    - if docker ps | grep -qw mysql; then docker stop mysql; fi
    - if docker ps -a | grep -qw mysql; then docker rm mysql; fi
    - run_task(mysql)

  apache:
    - run_task(stop)
    - run_task(rm)
    - > 
        if ! docker ps | grep -qw %name%; then 
        docker run --name %name% -d 
        --link mysql:mysql 
        -e VHOST=%hostName% 
        -e WEB_ROOT=%guest.rootFolder%
        -p %guest.port%:22 
        -v %rootFolder%/%projectFolder%:/var/www 
        factorial/drupal-docker:php-56
        ; fi

  rebuild:
    - docker pull factorial/drupal-docker:php-56
    - docker pull quay.io/sameersbn/mysql:latest

  run:
    - run_task(mysql)
    - run_task(apache)
    - run_task(reload_haproxy)
    - execute(waitForServices)
